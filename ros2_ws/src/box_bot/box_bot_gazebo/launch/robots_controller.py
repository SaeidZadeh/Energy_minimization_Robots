#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from geometry_msgs.msg import Twist, Point
from tf2_msgs.msg import TFMessage
import math
from std_msgs.msg import ColorRGBA
from visualization_msgs.msg import Marker, MarkerArray
from dataclasses import dataclass

@dataclass
class RobotTFWrapper:
    robot_name: str
    tf_message: TFMessage

class RobotController(Node):

    def __init__(self):
        super().__init__('robot_controller')
        self.velocities ={'box_bot0': 1.45007, 'box_bot1': 1.26235, 'box_bot2': 1.75208, 'box_bot3': 1.55568, 'box_bot4': 1.54308, 
                          'box_bot5':1.98118, 'box_bot6': 1.1683, 'box_bot7': 1.281,'box_bot8': 1.38364}
        self.waypoints = {
        'box_bot0': {'locations': [(-1, -1, 0.1), (17, 0, 0.1), (17, 0, 0.1), (17, 2, 0.1), (17, 2, 0.1), (18, 1, 0.1), (18, 1, 0.1), (19, 1, 0.1), (19, 1, 0.1), (19, 2, 0.1), (19, 2, 0.1), (19, 3, 0.1), (19, 3, 0.1), (19, 4, 0.1), (19, 4, 0.1), (17, 4, 0.1), (17, 4, 0.1), (17, 5, 0.1), (17, 5, 0.1), (17, 7, 0.1), (17, 7, 0.1), (17, 8, 0.1), (17, 8, 0.1), (17, 9, 0.1), (17, 9, 0.1), (16, 9, 0.1), (16, 9, 0.1), (15, 9, 0.1), (15, 9, 0.1), (14, 10, 0.1), (14, 10, 0.1), (13, 11, 0.1), (13, 11, 0.1), (12, 12, 0.1), (12, 12, 0.1), (13, 13, 0.1), (13, 13, 0.1), (13, 14, 0.1), (13, 14, 0.1), (12, 15, 0.1), (12, 15, 0.1), (7, 16, 0.1), (7, 16, 0.1), (9, 15, 0.1), (9, 15, 0.1), (-1, -1, 0.1), (-1, -1, 0.1)], 
                    'times': [0, 14.271087217794776, 14.996441765688376, 17.034996291370213, 17.760350839263815, 18.574261601171862, 19.299616149065464, 20.073231570774976, 20.798586118668577, 21.817863381509497, 22.5432179294031, 23.56249519224402, 24.28784974013762, 25.30712700297854, 26.03248155087214, 27.180663227737035, 27.906017775630637, 28.925295038471557, 29.65064958636516, 31.689204112046998, 32.414558659940596, 33.43383592278151, 34.159190470675114, 35.17846773351603, 35.90382228140963, 36.47791311984208, 37.20326766773568, 37.77735850616813, 38.50271305406173, 39.593117019553475, 40.31847156744708, 41.40887553293882, 42.134230080832424, 43.22463404632417, 43.94998859421777, 45.39410496910826, 46.119459517001864, 47.13873677984278, 47.86409132773638, 48.95449529322813, 49.67984984112173, 52.80353942884789, 53.52889397674149, 54.96583624345407, 55.69119079134767, 64.71468393351859, 78.78962853308384], 
                    'energy': [0, 0.22344852671743407, 0.23786147294099838, 0.26977999452558943, 0.28419294074915374, 0.2969366902513672, 0.3113496364749315, 0.323462464571962, 0.3378754107955263, 0.35383467158782184, 0.36824761781138615, 0.3842068786036817, 0.398619824827246, 0.41457908561954154, 0.42899203184310586, 0.44696960427217114, 0.46138255049573546, 0.477341811288031, 0.4917547575115953, 0.5236732790961863, 0.5380862253197506, 0.5540454861120461, 0.5684584323356103, 0.5844176931279058, 0.5988306393514701, 0.6078194255660028, 0.622232371789567, 0.6312211580040997, 0.645634104227664, 0.6627070262761096, 0.6771199724996738, 0.6941928945481194, 0.7086058407716836, 0.7256787628201292, 0.7400917090436935, 0.7627028578267688, 0.7771158040503331, 0.7930750648426286, 0.8074880110661928, 0.8245609331146384, 0.8389738793382027, 0.8878828254926117, 0.9022957717161759, 0.9247945924139133, 0.9392075386374775, 1.080492236691094, 1.080492236691094]}, 
        'box_bot1': {'locations': [(-1, -1, 0.3), (8, 0, 0.3), (8, 0, 0.3), (8, 1, 0.3), (8, 1, 0.3), (9, 2, 0.3), (9, 2, 0.3), (10, 5, 0.3), (10, 5, 0.3), (12, 2, 0.3), (12, 2, 0.3), (13, 1, 0.3), (13, 1, 0.3), (14, 4, 0.3), (14, 4, 0.3), (14, 5, 0.3), (14, 5, 0.3), (14, 7, 0.3), (14, 7, 0.3), (13, 9, 0.3), (13, 9, 0.3), (15, 6, 0.3), (15, 6, 0.3), (18, 7, 0.3), (18, 7, 0.3), (18, 8, 0.3), (18, 8, 0.3), (19, 6, 0.3), (19, 6, 0.3), (19, 8, 0.3), (19, 8, 0.3), (18, 12, 0.3), (18, 12, 0.3), (-1, -1, 0.3), (-1, -1, 0.3)], 
                    'times': [0, 10.084747192585299, 10.900931217740371, 12.453194748525243, 13.269378773680316, 15.470741082866597, 16.28692510802167, 21.55122910441221, 22.367413129567286, 24.76805334404373, 25.584237369198803, 26.59389462556908, 27.410078650724156, 32.6743826471147, 33.49056667226977, 35.04283020305464, 35.859014228209716, 38.96354128977946, 39.77972531493453, 42.570339949268636, 43.38652397442371, 45.78716418890015, 46.603348214055224, 50.56739341238944, 51.38357743754452, 52.93584096832939, 53.75202499348446, 55.18586018781868, 56.00204421297376, 59.1065712745435, 59.92275529969857, 65.69168352455519, 66.50786754971026, 80.30536067590668, 89.66686893111526], 
                    'energy': [0, 0.05824137496716871, 0.0593636194326903, 0.06832824299913656, 0.06945048746465815, 0.08216378262610512, 0.0832860270916267, 0.11368840576705555, 0.11481065023257714, 0.12867481402593287, 0.12979705849145445, 0.135628025369813, 0.1367502698353346, 0.16715264851076345, 0.16827489297628503, 0.1772395165427313, 0.17836176100825288, 0.1962910081411454, 0.19741325260666698, 0.21352959446465808, 0.21465183893017967, 0.2285160027235354, 0.22963824718905698, 0.2525313786056515, 0.25365362307117306, 0.26261824663761935, 0.2637404911031409, 0.27202116801051457, 0.27314341247603613, 0.29107265960892864, 0.2921949040744502, 0.32551158574095646, 0.326633830206478, 0.4063170344974657, 0.4063170344974657]}, 
        'box_bot2': {'locations': [(-1, -1, 0.5), (1, 0, 0.5), (1, 0, 0.5), (2, 0, 0.5), (2, 0, 0.5), (2, 3, 0.5), (2, 3, 0.5), (5, 0, 0.5), (5, 0, 0.5), (6, 3, 0.5), (6, 3, 0.5), (5, 6, 0.5), (5, 6, 0.5), (6, 6, 0.5), (6, 6, 0.5), (7, 5, 0.5), (7, 5, 0.5), (8, 4, 0.5), (8, 4, 0.5), (7, 8, 0.5), (7, 8, 0.5), (9, 6, 0.5), (9, 6, 0.5), (11, 5, 0.5), (11, 5, 0.5), (12, 3, 0.5), (12, 3, 0.5), (12, 4, 0.5), (12, 4, 0.5), (10, 8, 0.5), (10, 8, 0.5), (7, 12, 0.5), (7, 12, 0.5), (6, 13, 0.5), (6, 13, 0.5), (7, 13, 0.5), (7, 13, 0.5), (5, 14, 0.5), (5, 14, 0.5), (8, 13, 0.5), (8, 13, 0.5), (8, 14, 0.5), (8, 14, 0.5), (13, 10, 0.5), (13, 10, 0.5), (4, 18, 0.5), (4, 18, 0.5), (8, 16, 0.5), (8, 16, 0.5), (7, 17, 0.5), (7, 17, 0.5), (9, 17, 0.5), (9, 17, 0.5), (10, 17, 0.5), (10, 17, 0.5), (9, 18, 0.5), (9, 18, 0.5), (10, 18, 0.5), (10, 18, 0.5), (14, 16, 0.5), (14, 16, 0.5), (15, 17, 0.5), (15, 17, 0.5), (16, 17, 0.5), (16, 17, 0.5), (18, 16, 0.5), (18, 16, 0.5), (-1, -1, 0.5), (-1, -1, 0.5)], 
                    'times': [0, 1.4651706337839532, 2.102428904422258, 2.676410211774819, 3.313668482413124, 5.410584587983942, 6.047842858622246, 7.987656166189014, 8.62491443682732, 10.904602217588206, 11.541860488226511, 13.609762840424887, 14.247021111063193, 14.821002418415754, 15.45826068905406, 16.104865124909647, 16.742123395547953, 17.388727831403543, 18.02598610204185, 20.772597280645225, 21.40985555128353, 22.70306442299471, 23.340322693633016, 24.455171342909686, 25.092429613547992, 26.045589249746467, 26.682847520384772, 27.381819555575046, 28.01907782621335, 30.83575717241464, 31.473015443052947, 34.46222607307269, 35.099484343711, 35.90920358688663, 36.54646185752494, 37.1204431648775, 37.757701435515806, 38.91750438079259, 39.5547626514309, 41.19895952166561, 41.83621779230391, 42.535189827494186, 43.17244809813249, 46.18372323562576, 46.82098150626407, 53.59155714115602, 54.22881541179432, 56.45851271034766, 57.09577098098597, 57.9054902241616, 58.54274849479991, 59.69071110950503, 60.32796938014334, 60.9019506874959, 61.5392089581342, 62.34892820130984, 62.986186471948145, 63.560167779300706, 64.19742604993901, 66.42712334849236, 67.06438161913066, 68.05411841784422, 68.69137668848252, 69.26535799583507, 69.90261626647337, 71.01746491575004, 71.65472318638834, 81.88648519786635, 91.6349671992122], 
                    'energy': [0, 0.008453933002533815, 0.015403256268015156, 0.018715088627454073, 0.02566441189293541, 0.037763472479924884, 0.04471279574540622, 0.05590538407707429, 0.06285470734255563, 0.07600834782706, 0.08295767109254133, 0.09488932433358285, 0.10183864759906419, 0.1051504799585031, 0.11209980322398444, 0.11583066600120713, 0.12277998926668847, 0.12651085204391116, 0.1334601753093925, 0.1493079314358965, 0.15625725470137783, 0.1637189802558232, 0.17066830352130455, 0.17710090295486652, 0.18405022622034786, 0.18954989125549188, 0.19649921452097321, 0.20053223471663637, 0.2074815579821177, 0.22373360257907327, 0.2306829258445546, 0.24793046399059632, 0.2548797872560777, 0.25955181116566867, 0.26650113443115003, 0.26981296679058897, 0.27676229005607034, 0.2834542726616657, 0.29040359592714704, 0.29989049790527506, 0.3068398211707564, 0.31087284136641957, 0.31782216463190094, 0.3351970134567223, 0.3421463367222037, 0.3812120888511154, 0.38816141211659677, 0.4010266109837207, 0.4079759342492021, 0.41264795815879307, 0.41959728142427444, 0.42622094614315226, 0.4331702694086336, 0.43648210176807256, 0.4434314250335539, 0.4481034489431449, 0.4550527722086263, 0.4583646045680652, 0.4653139278335466, 0.47817912670067053, 0.4851284499661519, 0.49083916269375943, 0.4977884859592408, 0.5011003183186797, 0.5080496415841611, 0.5144822410177231, 0.5214315642832045, 0.580468121902104, 0.580468121902104]}, 
        'box_bot3': {'locations': [(-1, -1, 0.7), (4, 1, 0.7), (4, 1, 0.7), (3, 3, 0.7), (3, 3, 0.7), (5, 1, 0.7), (5, 1, 0.7), (6, 0, 0.7), (6, 0, 0.7), (7, 2, 0.7), (7, 2, 0.7), (6, 5, 0.7), (6, 5, 0.7), (7, 4, 0.7), (7, 4, 0.7), (8, 5, 0.7), (8, 5, 0.7), (6, 7, 0.7), (6, 7, 0.7), (5, 9, 0.7), (5, 9, 0.7), (5, 10, 0.7), (5, 10, 0.7), (7, 9, 0.7), (7, 9, 0.7), (5, 11, 0.7), (5, 11, 0.7), (6, 11, 0.7), (6, 11, 0.7), (9, 9, 0.7), (9, 9, 0.7), (9, 10, 0.7), (9, 10, 0.7), (8, 11, 0.7), (8, 11, 0.7), (8, 12, 0.7), (8, 12, 0.7), (9, 11, 0.7), (9, 11, 0.7), (6, 14, 0.7), (6, 14, 0.7), (9, 12, 0.7), (9, 12, 0.7), (14, 8, 0.7), (14, 8, 0.7), (16, 5, 0.7), (16, 5, 0.7), (15, 12, 0.7), (15, 12, 0.7), (16, 11, 0.7), (16, 11, 0.7), (17, 10, 0.7), (17, 10, 0.7), (14, 15, 0.7), (14, 15, 0.7), (13, 16, 0.7), (13, 16, 0.7), (16, 13, 0.7), (16, 13, 0.7), (17, 13, 0.7), (17, 13, 0.7), (17, 12, 0.7), (17, 12, 0.7), (18, 13, 0.7), (18, 13, 0.7), (18, 14, 0.7), (18, 14, 0.7), (-1, -1, 0.7), (-1, -1, 0.7)], 
                    'times': [0, 3.6335134590231952, 4.232886762744742, 5.713078273285488, 6.312451577007034, 7.652896119932095, 8.252269423653642, 8.922491695116172, 9.521864998837719, 11.229113768237806, 11.828487071959353, 14.006142512592968, 14.605515816314515, 15.275738087777045, 15.875111391498592, 16.9212772509244, 17.520650554645947, 19.214851205251172, 19.814224508972718, 21.294416019513463, 21.89378932323501, 22.632559879816423, 23.23193318353797, 24.39133327831683, 24.990706582038374, 26.6849072326436, 27.284280536365145, 27.884828891004663, 28.48420219472621, 30.286721053295977, 30.886094357017523, 31.624864913598937, 32.22423821732048, 33.071338542623096, 33.670711846344645, 34.40948240292606, 35.00885570664761, 35.679077978110136, 36.278451281831686, 38.81975225773952, 39.41912556146107, 41.22164442003084, 41.82101772375239, 44.94554337008876, 45.544916673810306, 47.175434527893806, 47.774807831615355, 52.85914172963333, 53.45851503335488, 54.128737304817406, 54.728110608538955, 55.39833288000148, 55.99770618372303, 59.77037444617658, 60.36974774989813, 61.216848075200744, 61.81622137892229, 63.826888193309884, 64.42626149703143, 65.02680985167095, 65.6261831553925, 66.03839413993154, 66.63776744365309, 67.6839333030789, 68.28330660680045, 69.02207716338187, 69.62145046710341, 79.71498244172349, 95.09721207668173], 
                     'energy': [0, 0.03960233427922743, 0.04324983788488154, 0.05938271854124434, 0.06303022214689845, 0.07763997479274534, 0.08128747839839945, 0.0885923547213229, 0.09223985832697701, 0.11084747798383605, 0.11449498158949016, 0.13822965043756835, 0.14187715404322246, 0.1491820303661459, 0.15282953397180002, 0.16423188889458432, 0.16787939250023842, 0.1863447983004387, 0.18999230190609281, 0.20612518256245563, 0.20977268616810973, 0.21782468291102347, 0.22147218651667758, 0.23410870228429603, 0.23775620588995014, 0.25622161169015045, 0.2598691152958046, 0.2664146027308966, 0.27006210633655076, 0.28970809229111544, 0.29335559589676957, 0.3014075926396833, 0.30505509624533744, 0.3142877991454376, 0.3179353027510917, 0.32598729949400546, 0.3296348030996596, 0.336939679422583, 0.34058718302823715, 0.3682852917285376, 0.3719327953341917, 0.3915787812887564, 0.39522628489441053, 0.42928106699600116, 0.4329285706016553, 0.45069988584071385, 0.454347389446368, 0.5097624836485084, 0.5134099872541625, 0.520714863577086, 0.5243623671827401, 0.5316672435056635, 0.5353147471113177, 0.5764337552942357, 0.5800812588998898, 0.58931396179999, 0.5929614654056441, 0.6148760943744145, 0.6185235979800686, 0.6250690854151607, 0.6287165890208148, 0.6332093526743375, 0.6368568562799917, 0.648259211202776, 0.6519067148084301, 0.6599587115513439, 0.663606215156998, 0.773617484366507, 0.773617484366507]}, 
        'box_bot4': {'locations': [(-1, -1, 0.9), (1, 4, 0.9), (1, 4, 0.9), (4, 3, 0.9), (4, 3, 0.9), (4, 4, 0.9), (4, 4, 0.9), (5, 3, 0.9), (5, 3, 0.9), (5, 4, 0.9), (5, 4, 0.9), (3, 7, 0.9), (3, 7, 0.9), (1, 9, 0.9), (1, 9, 0.9), (3, 9, 0.9), (3, 9, 0.9), (0, 10, 0.9), (0, 10, 0.9), (3, 10, 0.9), (3, 10, 0.9), (3, 11, 0.9), (3, 11, 0.9), (1, 12, 0.9), (1, 12, 0.9), (3, 12, 0.9), (3, 12, 0.9), (8, 10, 0.9), (8, 10, 0.9), (5, 13, 0.9), (5, 13, 0.9), (1, 14, 0.9), (1, 14, 0.9), (2, 15, 0.9), (2, 15, 0.9), (4, 15, 0.9), (4, 15, 0.9), (7, 15, 0.9), (7, 15, 0.9), (5, 16, 0.9), (5, 16, 0.9), (12, 16, 0.9), (12, 16, 0.9), (4, 17, 0.9), (4, 17, 0.9), (1, 18, 0.9), (1, 18, 0.9), (3, 19, 0.9), (3, 19, 0.9), (4, 19, 0.9), (4, 19, 0.9), (13, 18, 0.9), (13, 18, 0.9), (12, 19, 0.9), (12, 19, 0.9), (16, 19, 0.9), (16, 19, 0.9), (17, 19, 0.9), (17, 19, 0.9), (-1, -1, 0.9), (-1, -1, 0.9)], 
                    'times': [0, 4.020991588807185, 4.683591194933289, 6.368376199762439, 7.030975805888543, 7.753342588122234, 8.415942194248338, 9.07654129310671, 9.739140899232813, 10.461507681466504, 11.124107287592608, 13.379002598659715, 14.04160220478582, 15.705173510191326, 16.36777311631743, 17.54709981929667, 18.209699425422773, 19.819774226660034, 20.482373832786138, 22.251363887254996, 22.9139634933811, 23.636330275614792, 24.298929881740897, 25.487292213160547, 26.14989181928665, 27.32921852226589, 27.991818128391994, 30.809686006789516, 31.47228561291562, 33.96764257102388, 34.63024217714998, 36.683184690627726, 37.34578429675383, 38.368690787597615, 39.031290393723715, 40.210617096702954, 40.873216702829055, 42.64220675729791, 43.304806363424014, 44.49316869484367, 45.15576830096977, 49.283411761397105, 49.946011367523205, 53.82788758257897, 54.49048718870507, 56.10056198994233, 56.76316159606843, 58.27420782821582, 58.93680743434192, 59.52647078583154, 60.18907039195764, 65.34452468913386, 66.00712429525997, 66.83890994796272, 67.50150955408883, 69.8601629600473, 70.52276256617341, 71.11242591766303, 71.77502552378914, 82.67169629737292, 107.11329231787855], 
                    'energy': [0, 0.035606211781843436, 0.046576708768664446, 0.06149561878474243, 0.07246611577156345, 0.07886273313927387, 0.08983323012609488, 0.09568288956888513, 0.10665338655570614, 0.11305000392341656, 0.12402050091023757, 0.1439877846556777, 0.1549582816424987, 0.16968934260252364, 0.18065983958934465, 0.19110287470116852, 0.20207337168798953, 0.2163307166963808, 0.2273012136832018, 0.2429657663509376, 0.25393626333775865, 0.26033288070546906, 0.27130337769229007, 0.2818264240383396, 0.2927969210251606, 0.30323995613698446, 0.31421045312380547, 0.3391629053325502, 0.35013340231937123, 0.37222999375940863, 0.38320049074622964, 0.401379465831458, 0.412349962818279, 0.4214078840652147, 0.4323783810520357, 0.44282141616385956, 0.45379191315068057, 0.4694564658184164, 0.4804269628052374, 0.4909500091512869, 0.5019205061381079, 0.5384711290294915, 0.5494416260163125, 0.5838159597027898, 0.5947864566896108, 0.6090438016980021, 0.6200142986848232, 0.6333947375556135, 0.6443652345424346, 0.6495867520983465, 0.6605572490851676, 0.706209221610513, 0.7171797185973341, 0.7245452490773465, 0.7355157460641676, 0.7564018162878153, 0.7673723132746364, 0.7725938308305483, 0.7835643278173694, 0.8800552452222336, 0.8800552452222336]}, 
        'box_bot5': {'locations': [(-1, -1, 1.1), (0, 0, 1.1), (0, 0, 1.1), (1, 1, 1.1), (1, 1, 1.1), (1, 3, 1.1), (1, 3, 1.1), (0, 4, 1.1), (0, 4, 1.1), (0, 5, 1.1), (0, 5, 1.1), (0, 6, 1.1), (0, 6, 1.1), (1, 6, 1.1), (1, 6, 1.1), (3, 6, 1.1), (3, 6, 1.1), (1, 7, 1.1), (1, 7, 1.1), (0, 9, 1.1), (0, 9, 1.1), (4, 8, 1.1), (4, 8, 1.1), (5, 8, 1.1), (5, 8, 1.1), (6, 8, 1.1), (6, 8, 1.1), (4, 10, 1.1), (4, 10, 1.1), (0, 12, 1.1), (0, 12, 1.1), (1, 13, 1.1), (1, 13, 1.1), (5, 12, 1.1), (5, 12, 1.1), (7, 11, 1.1), (7, 11, 1.1), (4, 13, 1.1), (4, 13, 1.1), (0, 14, 1.1), (0, 14, 1.1), (3, 15, 1.1), (3, 15, 1.1), (1, 16, 1.1), (1, 16, 1.1), (0, 17, 1.1), (0, 17, 1.1), (8, 15, 1.1), (8, 15, 1.1), (6, 16, 1.1), (6, 16, 1.1), (6, 17, 1.1), (6, 17, 1.1), (6, 18, 1.1), (6, 18, 1.1), (5, 18, 1.1), (5, 18, 1.1), (3, 17, 1.1), (3, 17, 1.1), (0, 18, 1.1), (0, 18, 1.1), (6, 19, 1.1), (6, 19, 1.1), (12, 17, 1.1), (12, 17, 1.1), (16, 16, 1.1), (16, 16, 1.1), (17, 15, 1.1), (17, 15, 1.1), (18, 15, 1.1), (18, 15, 1.1), (-1, -1, 1.1), (-1, -1, 1.1), (19, 18, 1.1), (19, 18, 1.1), (-1, -1, 1.1), (-1, -1, 1.1)], 
                    'times': [0, 1.0135807927606313, 1.5945848906109201, 2.6081656833715514, 3.1891697812218402, 4.620748821597934, 5.201752919448223, 6.027361641266536, 6.608365739116825, 7.324155259304872, 7.905159357155161, 8.620948877343208, 9.201952975193496, 9.787226322578238, 10.368230420428528, 11.538777115198013, 12.119781213048302, 13.300163804978187, 13.881167902828476, 15.31996820330424, 15.900972301154528, 18.13529321320552, 18.71629731105581, 19.301570658440554, 19.882574756290843, 20.467848103675585, 21.048852201525875, 22.7000696451625, 23.28107374301279, 25.64183892687256, 26.22284302472285, 27.23642381748348, 27.81742791533377, 30.051748827384763, 30.632752925235053, 31.766603724112677, 32.34760782196297, 34.32572802406137, 34.90673212191166, 36.94675384260175, 37.52775794045204, 39.56717619349354, 40.14818029134383, 41.32856288327371, 41.909566981124, 42.735175702942314, 43.316179800792604, 47.78482162489459, 48.36582572274488, 49.546208314674764, 50.127212412525054, 50.8430019327131, 51.42400603056339, 52.13979555075144, 52.72079964860173, 53.18422259583999, 53.76522669369028, 54.7071555315299, 55.28815962938019, 56.88787369814578, 57.46887779599607, 61.215543223636345, 61.796547321486635, 65.14343500092778, 65.72443909877806, 67.95876001082905, 68.53976410867934, 69.19646118204525, 69.77746527989554, 70.36273862728028, 70.94374272513056, 81.08058767331565, 93.63440347363272, 113.3235474146573, 113.90455151250758, 125.09403463066391, 127.29285784957999], 
                    'energy': [0, 0.002184339247396696, 0.010686043109133474, 0.01287038235653017, 0.021372086218266948, 0.02445724164542044, 0.03295894550715722, 0.03473819147051937, 0.04323989533225615, 0.044782473045832896, 0.053284176907569675, 0.054826754621146424, 0.06332845848288321, 0.0645897644905333, 0.07309146835227008, 0.07561408036757028, 0.08411578422930706, 0.08665959330788457, 0.09516129716962135, 0.09826201492980643, 0.10676371879154321, 0.11157884048123051, 0.12008054434296729, 0.12134185035061738, 0.12984355421235416, 0.13110486022000425, 0.13960656408174105, 0.14316505600846535, 0.15166675987020212, 0.15675437802735714, 0.1652560818890939, 0.1674404211364906, 0.17594212499822737, 0.18075724668791465, 0.18925895054965142, 0.19170248027946685, 0.2002041841412036, 0.20446717494013467, 0.21296887880187143, 0.2173652718095845, 0.2258669756713213, 0.2302620681630037, 0.23876377202474047, 0.241307581103318, 0.24980928496505478, 0.25158853092841693, 0.2600902347901537, 0.26972047816952827, 0.27822218203126503, 0.2807659911098425, 0.2892676949715793, 0.290810272685156, 0.2993119765468928, 0.30085455426046953, 0.3093562581222063, 0.31035496778504407, 0.31885667164678083, 0.3208865957963338, 0.32938829965807054, 0.3328357981209213, 0.34133750198265805, 0.3494118344866992, 0.357913538348436, 0.36512632115474775, 0.3736280250164845, 0.3784431467061718, 0.38694485056790856, 0.38836007982368087, 0.39686178368541764, 0.39812308969306776, 0.4066247935548045, 0.4284704208824376, 0.4284704208824376, 0.47090193711202705, 0.4794036409737638, 0.5035177789957576, 0.5035177789957576]}, 
        'box_bot6': {'locations': [(-1, -1, 1.3), (12, 5, 1.3), (12, 5, 1.3), (14, 2, 1.3), (14, 2, 1.3), (15, 4, 1.3), (15, 4, 1.3), (16, 1, 1.3), (16, 1, 1.3), (16, 2, 1.3), (16, 2, 1.3), (16, 4, 1.3), (16, 4, 1.3), (19, 10, 1.3), (19, 10, 1.3), (-1, -1, 1.3), (-1, -1, 1.3)], 
                    'times': [0, 24.574340437455728, 25.570202383372287, 28.27546353410981, 29.27132548002637, 34.456415968488756, 35.452277914405315, 37.63482270852505, 38.63068465444161, 40.73550275681919, 41.731364702735746, 45.941000907490896, 46.936862853407455, 62.49213431879462, 63.48799626471118, 79.05273052512383, 93.52164258113848], 
                    'energy': [0, 0.11865471045509386, 0.13800614859684973, 0.15106822769366754, 0.17041966583542342, 0.1954553493833829, 0.2148067875251388, 0.2253449837082939, 0.24469642185004978, 0.2548593225852244, 0.2742107607269803, 0.29453656219732965, 0.31388800033908554, 0.388995050982964, 0.4083464891247199, 0.4834992299146555, 0.4834992299146555]}, 
        'box_bot7': {'locations': [(-1, -1, 1.5)], 
                    'times': [0], 
                    'energy': [0]}, 
        'box_bot8': {'locations': [(-1, -1, 1.7)], 
                    'times': [0], 
                    'energy': [0]}}
        
        self.waypoints = {
            'box_bot0': {'locations': [(-2, -1, 1)], 
                         'times': [0], 
                         'energy': [0]}, 
            'box_bot1': {'locations': [(-2, 0, 1), (12, 3, 1), (12, 3, 1), (13, 0, 1), (13, 0, 1), (14, 3, 1), (14, 3, 1), (15, 2, 1), (15, 2, 1), (15, 3, 1), (15, 3, 1), (15, 4, 1), (15, 4, 1), (-2, 0, 1), (-2, 0, 1)], 
                         'times': [0, 54.68272257444033, 0.7223542492133228, 12.713474758724061, 0.7223542492133228, 12.713474758724061, 0.7223542492133228, 5.685638758146948, 0.7223542492133228, 4.020353721262768, 0.7223542492133228, 4.020353721262768, 0.7223542492133228, 67.39340899809163, 0], 
                         'energy': [0, 0.5139830443367188, 0.5167958541075427, 0.6362944846245494, 0.6391072943953733, 0.75860592491238, 0.7614187346832039, 0.8148601468940354, 0.8176729566648593, 0.8554617416353238, 0.8582745514061477, 0.8960633363766123, 0.8988761461474362, 1.5323316124131132, 1.5323316124131132]}, 
            'box_bot2': {'locations': [(-2, 1, 1), (6, 5, 1), (6, 5, 1), (7, 5, 1), (7, 5, 1), (8, 7, 1), (8, 7, 1), (5, 11, 1), (5, 11, 1), (6, 11, 1), (6, 11, 1), (10, 11, 1), (10, 11, 1), (15, 6, 1), (15, 6, 1), (15, 7, 1), (15, 7, 1), (14, 9, 1), (14, 9, 1), (14, 10, 1), (14, 10, 1), (16, 8, 1), (16, 8, 1), (18, 3, 1), (18, 3, 1), (18, 8, 1), (18, 8, 1), (17, 9, 1), (17, 9, 1), (15, 12, 1), (15, 12, 1), (17, 10, 1), (17, 10, 1), (17, 11, 1), (17, 11, 1), (18, 10, 1), (18, 10, 1), (18, 11, 1), (18, 11, 1), (19, 11, 1), (19, 11, 1), (19, 10, 1), (19, 10, 1), (19, 9, 1), (19, 9, 1), (17, 12, 1), (17, 12, 1), (16, 13, 1), (16, 13, 1), (16, 14, 1), (16, 14, 1), (15, 17, 1), (15, 17, 1), (16, 17, 1), (16, 17, 1), (14, 19, 1), (14, 19, 1), (15, 19, 1), (15, 19, 1), (-2, 1, 1), (-2, 1, 1)], 
                         'times': [0, 40.54807913966701, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 9.834353718161834, 0.6177814443895765, 21.990283428587666, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 17.592226742870135, 0.6177814443895765, 31.098957065137004, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 9.834353718161834, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 12.439582826054803, 0.6177814443895765, 23.684260083708676, 0.6177814443895765, 21.990283428587666, 0.6177814443895765, 6.2197914130274015, 0.6177814443895765, 15.857418892751777, 0.6177814443895765, 12.439582826054803, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 6.2197914130274015, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 15.857418892751777, 0.6177814443895765, 6.2197914130274015, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 13.90787640539874, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 12.439582826054803, 0.6177814443895765, 4.398056685717534, 0.6177814443895765, 112.64521344768609, 0], 
                         'energy': [0, 0.04549059188672346, 0.05150185980357088, 0.05643600726578517, 0.062447275182632586, 0.0734803643191518, 0.07949163223599921, 0.10416236954707063, 0.11017363746391805, 0.11510778492613233, 0.12111905284297975, 0.14085564269183687, 0.1468669106086843, 0.18175660190774542, 0.18776786982459284, 0.19270201728680714, 0.19871328520365455, 0.20974637434017376, 0.21575764225702118, 0.22069178971923548, 0.2267030576360829, 0.24065893415570735, 0.24667020207255477, 0.27324139933928315, 0.27925266725613057, 0.303923404567202, 0.30993467248404943, 0.3169126107438617, 0.3229238786607091, 0.3407142003364232, 0.3467254682532706, 0.36068134477289504, 0.36669261268974246, 0.3716267601519567, 0.37763802806880414, 0.3846159663286164, 0.3906272342454638, 0.3955613817076781, 0.4015726496245255, 0.40650679708673976, 0.4125180650035872, 0.41745221246580144, 0.42346348038264886, 0.4283976278448631, 0.43440889576171055, 0.45219921743742464, 0.45821048535427206, 0.4651884236140843, 0.4711996915309317, 0.476133838993146, 0.4821451069099934, 0.49774825120173016, 0.5037595191185775, 0.5086936665807918, 0.5147049344976392, 0.5286608110172637, 0.5346720789341111, 0.5396062263963254, 0.5456174943131727, 0.671993331138661, 0.671993331138661]}, 
            'box_bot3': {'locations': [(-2, 2, 1), (2, 12, 1), (2, 12, 1), (0, 13, 1), (0, 13, 1), (0, 16, 1), (0, 16, 1), (3, 17, 1), (3, 17, 1), (4, 16, 1), (4, 16, 1), (7, 15, 1), (7, 15, 1), (7, 17, 1), (7, 17, 1), (6, 18, 1), (6, 18, 1), (4, 19, 1), (4, 19, 1), (-2, 2, 1), (-2, 2, 1)], 
                         'times': [0, 64.73635782266615, 0.7210839479111101, 10.849838221939292, 0.7210839479111101, 14.556585485479022, 0.7210839479111101, 15.343988363020532, 0.7210839479111101, 6.862040205135926, 0.7210839479111101, 15.343988363020532, 0.7210839479111101, 9.704390323652682, 0.7210839479111101, 6.862040205135926, 0.7210839479111101, 10.849838221939292, 0.7210839479111101, 100.03056584160491, 0], 
                         'energy': [0, 0.37829244076961993, 0.3809362029142916, 0.44433816003669013, 0.4469819221813618, 0.5320445738006878, 0.5346883359453595, 0.6243522435888529, 0.6269960057335245, 0.6670949242573474, 0.6697386864020191, 0.7594025940455125, 0.7620463561901841, 0.8187547906030681, 0.8213985527477398, 0.8614974712715626, 0.8641412334162343, 0.9275431905386328, 0.9301869526833044, 1.5147241150526352, 1.5147241150526352]}, 
            'box_bot4': {'locations': [(-2, 3, 1), (1, 0, 1), (1, 0, 1), (2, 0, 1), (2, 0, 1), (2, 1, 1), (2, 1, 1), (3, 1, 1), (3, 1, 1), (6, 1, 1), (6, 1, 1), (6, 4, 1), (6, 4, 1), (7, 3, 1), (7, 3, 1), (7, 4, 1), (7, 4, 1), (8, 2, 1), (8, 2, 1), (9, 1, 1), (9, 1, 1), (11, 0, 1), (11, 0, 1), (12, 0, 1), (12, 0, 1), (12, 1, 1), (12, 1, 1), (12, 2, 1), (12, 2, 1), (11, 8, 1), (11, 8, 1), (9, 11, 1), (9, 11, 1), (11, 9, 1), (11, 9, 1), (11, 10, 1), (11, 10, 1), (12, 9, 1), (12, 9, 1), (19, 1, 1), (19, 1, 1), (17, 0, 1), (17, 0, 1), (17, 5, 1), (17, 5, 1), (15, 10, 1), (15, 10, 1), (16, 9, 1), (16, 9, 1), (18, 5, 1), (18, 5, 1), (18, 6, 1), (18, 6, 1), (19, 6, 1), (19, 6, 1), (19, 5, 1), (19, 5, 1), (19, 7, 1), (19, 7, 1), (19, 8, 1), (19, 8, 1), (9, 19, 1), (9, 19, 1), (5, 19, 1), (5, 19, 1), (6, 19, 1), (6, 19, 1), (7, 19, 1), (7, 19, 1), (17, 13, 1), (17, 13, 1), (13, 16, 1), (13, 16, 1), (12, 17, 1), (12, 17, 1), (12, 18, 1), (12, 18, 1), (13, 19, 1), (13, 19, 1), (19, 17, 1), (19, 17, 1), (16, 18, 1), (16, 18, 1), (17, 18, 1), (17, 18, 1), (18, 19, 1), (18, 19, 1), (-2, 3, 1), (-2, 3, 1)], 
                         'times': [0, 5.775770036459444, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 7.749008654357853, 0.8054132853194433, 7.749008654357853, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 5.775770036459444, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 5.775770036459444, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 15.711793163228192, 0.8054132853194433, 9.31314934576715, 0.8054132853194433, 7.3058354226262425, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 27.4576972999889, 0.8054132853194433, 5.775770036459444, 0.8054132853194433, 12.915014423929756, 0.8054132853194433, 13.909896231876203, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 11.551540072918888, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 5.166005769571902, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 38.39909845974997, 0.8054132853194433, 10.332011539143805, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 30.12273113086704, 0.8054132853194433, 12.915014423929756, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 16.336344637418183, 0.8054132853194433, 8.168172318709091, 0.8054132853194433, 2.583002884785951, 0.8054132853194433, 3.6529177113131213, 0.8054132853194433, 71.25530766223908, 0], 
                         'energy': [0, 0.008607047363990294, 0.009182121906128146, 0.013031310504416681, 0.013606385046554533, 0.01745557364484307, 0.01803064818698092, 0.021879836785269453, 0.022454911327407304, 0.0340024771222729, 0.034577551664410754, 0.04612511745927636, 0.04670019200141421, 0.05214376672124574, 0.05271884126338359, 0.05656802986167212, 0.05714310440380997, 0.06575015176780026, 0.06632522630993812, 0.07176880102976965, 0.07234387557190751, 0.0809509229358978, 0.08152599747803566, 0.08537518607632419, 0.08595026061846205, 0.08979944921675058, 0.09037452375888844, 0.09422371235717697, 0.09479878689931483, 0.11821248707703545, 0.11878756161917331, 0.132666008479234, 0.13324108302137183, 0.1441282324610349, 0.14470330700317274, 0.14855249560146128, 0.14912757014359912, 0.15457114486343065, 0.1551462194055685, 0.19606365546609134, 0.19663873000822918, 0.20524577737221947, 0.2058208519143573, 0.22506679490579998, 0.22564186944793782, 0.24637038442346462, 0.24694545896560247, 0.25238903368543397, 0.2529641082275718, 0.2701782029555524, 0.27075327749769024, 0.27460246609597877, 0.2751775406381166, 0.27902672923640515, 0.279601803778543, 0.2834509923768315, 0.28402606691896937, 0.29172444411554643, 0.2922995186576843, 0.2961487072559728, 0.29672378179811065, 0.35394608412166256, 0.3545211586638004, 0.36991791305695454, 0.3704929875990924, 0.3743421761973809, 0.37491725073951876, 0.3787664393378073, 0.37934151387994514, 0.4242303809815601, 0.4248054555236979, 0.4440513985151406, 0.4446264730572784, 0.45007004777710996, 0.4506451223192478, 0.45449431091753634, 0.4550693854596742, 0.4605129601795057, 0.46108803472164356, 0.4854324409499289, 0.4860075154920667, 0.4981797186062094, 0.49875479314834725, 0.5026039817466358, 0.5031790562887737, 0.5086226310086052, 0.5091977055507431, 0.6153823015635969, 0.6153823015635969]}, 
            'box_bot5': {'locations': [(-2, 4, 1), (1, 2, 1), (1, 2, 1), (2, 4, 1), (2, 4, 1), (0, 5, 1), (0, 5, 1), (0, 7, 1), (0, 7, 1), (1, 7, 1), (1, 7, 1), (2, 7, 1), (2, 7, 1), (3, 8, 1), (3, 8, 1), (1, 9, 1), (1, 9, 1), (2, 9, 1), (2, 9, 1), (3, 9, 1), (3, 9, 1), (1, 10, 1), (1, 10, 1), (3, 10, 1), (3, 10, 1), (1, 11, 1), (1, 11, 1), (2, 11, 1), (2, 11, 1), (0, 12, 1), (0, 12, 1), (1, 13, 1), (1, 13, 1), (1, 14, 1), (1, 14, 1), (0, 15, 1), (0, 15, 1), (1, 15, 1), (1, 15, 1), (3, 15, 1), (3, 15, 1), (3, 16, 1), (3, 16, 1), (6, 15, 1), (6, 15, 1), (6, 16, 1), (6, 16, 1), (6, 17, 1), (6, 17, 1), (5, 17, 1), (5, 17, 1), (4, 17, 1), (4, 17, 1), (10, 14, 1), (10, 14, 1), (5, 18, 1), (5, 18, 1), (0, 17, 1), (0, 17, 1), (1, 17, 1), (1, 17, 1), (1, 18, 1), (1, 18, 1), (2, 18, 1), (2, 18, 1), (16, 11, 1), (16, 11, 1), (15, 14, 1), (15, 14, 1), (9, 17, 1), (9, 17, 1), (9, 18, 1), (9, 18, 1), (-2, 4, 1), (-2, 4, 1)], 
                         'times': [0, 8.254666008187426, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 4.578864854515294, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 3.2377463887645193, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 4.578864854515294, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 5.1193265372404415, 0.9375914606607602, 3.2377463887645193, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 3.2377463887645193, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 4.578864854515294, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 7.239821019181926, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 15.357979611721325, 0.9375914606607602, 14.659520264938157, 0.9375914606607602, 11.673860621638836, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 35.83528576068309, 0.9375914606607602, 7.239821019181926, 0.9375914606607602, 15.357979611721325, 0.9375914606607602, 2.289432427257647, 0.9375914606607602, 49.15619886412339, 0], 
                         'energy': [0, 0.036343830238790904, 0.03720474396363418, 0.05974423065175257, 0.060605144376595844, 0.08314463106471423, 0.0840055447895575, 0.10416547455459124, 0.10502638827943452, 0.11510635316195138, 0.11596726688679465, 0.1260472317693115, 0.12690814549415477, 0.14116336853925465, 0.1420242822640979, 0.1645637689522163, 0.16542468267705956, 0.17550464755957643, 0.1763655612844197, 0.18644552616693655, 0.1873064398917798, 0.2098459265798982, 0.21070684030474146, 0.23086677006977518, 0.23172768379461844, 0.25426717048273684, 0.2551280842075801, 0.265208049090097, 0.26606896281494025, 0.28860844950305864, 0.2894693632279019, 0.30372458627300175, 0.304585499997845, 0.3146654648803619, 0.31552637860520516, 0.329781601650305, 0.33064251537514827, 0.34072248025766516, 0.3415833939825084, 0.36174332374754214, 0.3626042374723854, 0.3726842023549023, 0.37354511607974555, 0.4054207638430104, 0.40628167756785366, 0.41636164245037055, 0.4172225561752138, 0.4273025210577307, 0.42816343478257396, 0.43824339966509085, 0.4391043133899341, 0.449184278272451, 0.45004519199729426, 0.5176636520616494, 0.5185245657864928, 0.5830678332382084, 0.5839287469630517, 0.6353266845953353, 0.6361875983201786, 0.6462675632026954, 0.6471284769275387, 0.6572084418100556, 0.6580693555348989, 0.6681493204174157, 0.669010234142259, 0.8267866409590878, 0.8276475546839311, 0.859523202447196, 0.8603841161720394, 0.9280025762363946, 0.9288634899612379, 0.9389434548437547, 0.9398043685685981, 1.1562303929443845, 1.1562303929443845]}, 
            'box_bot6': {'locations': [(-2, 5, 1), (5, 2, 1), (5, 2, 1), (4, 4, 1), (4, 4, 1), (2, 6, 1), (2, 6, 1), (3, 7, 1), (3, 7, 1), (4, 7, 1), (4, 7, 1), (5, 7, 1), (5, 7, 1), (6, 7, 1), (6, 7, 1), (7, 7, 1), (7, 7, 1), (6, 8, 1), (6, 8, 1), (7, 8, 1), (7, 8, 1), (8, 8, 1), (8, 8, 1), (4, 11, 1), (4, 11, 1), (1, 12, 1), (1, 12, 1), (3, 13, 1), (3, 13, 1), (2, 15, 1), (2, 15, 1), (5, 14, 1), (5, 14, 1), (6, 14, 1), (6, 14, 1), (9, 13, 1), (9, 13, 1), (8, 14, 1), (8, 14, 1), (12, 11, 1), (12, 11, 1), (12, 12, 1), (12, 12, 1), (12, 14, 1), (12, 14, 1), (12, 15, 1), (12, 15, 1), (11, 15, 1), (11, 15, 1), (2, 17, 1), (2, 17, 1), (0, 18, 1), (0, 18, 1), (2, 19, 1), (2, 19, 1), (3, 19, 1), (3, 19, 1), (14, 13, 1), (14, 13, 1), (14, 14, 1), (14, 14, 1), (14, 15, 1), (14, 15, 1), (15, 15, 1), (15, 15, 1), (15, 13, 1), (15, 13, 1), (-2, 5, 1), (-2, 5, 1), (19, 19, 1), (19, 19, 1), (-2, 5, 1), (-2, 5, 1)], 
                         'times': [0, 16.084936366205152, 0.7068339065263207, 5.361645455401717, 0.7068339065263207, 6.782004658144067, 0.7068339065263207, 3.3910023290720335, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 3.3910023290720335, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 11.989003709531056, 0.7068339065263207, 7.582511719665178, 0.7068339065263207, 5.361645455401717, 0.7068339065263207, 5.361645455401717, 0.7068339065263207, 7.582511719665178, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 7.582511719665178, 0.7068339065263207, 3.3910023290720335, 0.7068339065263207, 11.989003709531056, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 4.795601483812423, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 22.106630539734184, 0.7068339065263207, 5.361645455401717, 0.7068339065263207, 5.361645455401717, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 30.044357181808675, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 2.3978007419062113, 0.7068339065263207, 4.795601483812423, 0.7068339065263207, 50.9779430326927, 0, 67.82004658144066, 0.7068339065263207, 67.82004658144066, 0], 
                         'energy': [0, 0.07330021468649492, 0.0740822863828505, 0.0985156912783488, 0.09929776297470438, 0.13020384715985758, 0.13098591885621316, 0.14643896094878978, 0.14722103264514536, 0.15814798349876744, 0.15893005519512302, 0.1698570060487451, 0.17063907774510068, 0.18156602859872276, 0.18234810029507834, 0.19327505114870042, 0.194057122845056, 0.2095101649376326, 0.2102922366339882, 0.22121918748761027, 0.22200125918396585, 0.23292821003758793, 0.2337102817339435, 0.28834503600205386, 0.28912710769840944, 0.32368116027657634, 0.3244632319729319, 0.3488966368684302, 0.3496787085647858, 0.37411211346028406, 0.37489418515663964, 0.40944823773480654, 0.4102303094311621, 0.4211572602847842, 0.42193933198113975, 0.45649338455930666, 0.45727545625566224, 0.4727284983482388, 0.4735105700445944, 0.5281453243127048, 0.5289273960090604, 0.5398543468626824, 0.540636418559038, 0.5624903202662821, 0.5632723919626377, 0.5741993428162597, 0.5749814145126153, 0.5859083653662374, 0.5866904370625929, 0.6874319462402161, 0.6882140179365717, 0.7126474228320699, 0.7134294945284255, 0.7378628994239238, 0.7386449711202794, 0.7495719219739014, 0.750353993670257, 0.8872682954371767, 0.8880503671335322, 0.8989773179871543, 0.8997593896835099, 0.9106863405371319, 0.9114684122334875, 0.9223953630871096, 0.9231774347834651, 0.9450313364907093, 0.9458134081870648, 1.1781235699122408, 1.1781235699122408, 1.4871844117637727, 1.4879664834601283, 1.7970273253116602, 1.7970273253116602]}, 
            'box_bot7': {'locations': [(-2, 6, 1), (3, 0, 1), (3, 0, 1), (4, 0, 1), (4, 0, 1), (4, 1, 1), (4, 1, 1), (1, 8, 1), (1, 8, 1), (8, 3, 1), (8, 3, 1), (9, 3, 1), (9, 3, 1), (9, 5, 1), (9, 5, 1), (9, 6, 1), (9, 6, 1), (10, 5, 1), (10, 5, 1), (8, 9, 1), (8, 9, 1), (9, 8, 1), (9, 8, 1), (9, 9, 1), (9, 9, 1), (10, 8, 1), (10, 8, 1), (12, 5, 1), (12, 5, 1), (13, 5, 1), (13, 5, 1), (12, 8, 1), (12, 8, 1), (13, 7, 1), (13, 7, 1), (14, 6, 1), (14, 6, 1), (16, 0, 1), (16, 0, 1), (16, 1, 1), (16, 1, 1), (16, 2, 1), (16, 2, 1), (17, 2, 1), (17, 2, 1), (18, 2, 1), (18, 2, 1), (18, 1, 1), (18, 1, 1), (16, 5, 1), (16, 5, 1), (16, 6, 1), (16, 6, 1), (9, 15, 1), (9, 15, 1), (9, 16, 1), (9, 16, 1), (15, 11, 1), (15, 11, 1), (16, 10, 1), (16, 10, 1), (-2, 6, 1), (-2, 6, 1), (13, 18, 1), (13, 18, 1), (17, 15, 1), (17, 15, 1), (14, 17, 1), (14, 17, 1), (16, 16, 1), (16, 16, 1), (17, 16, 1), (17, 16, 1), (18, 15, 1), (18, 15, 1), (18, 16, 1), (18, 16, 1), (19, 14, 1), (19, 14, 1), (18, 18, 1), (18, 18, 1), (17, 19, 1), (17, 19, 1), (-2, 6, 1), (-2, 6, 1)], 
                         'times': [0, 8.50894783924321, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 15.7168459887805, 0.7982748169518101, 17.75281635733123, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 4.127445965184813, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 9.229249751610473, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 7.440859032090399, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 6.526065084628025, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 13.05213016925605, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 9.229249751610473, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 23.530062289641577, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 16.118191755953458, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 41.78720551844596, 0, 48.70561127556264, 0.7982748169518101, 10.318614912962033, 0.7982748169518101, 7.440859032090399, 0.7982748169518101, 4.614624875805236, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 2.0637229825924064, 0.7982748169518101, 4.614624875805236, 0.7982748169518101, 8.50894783924321, 0.7982748169518101, 2.9185450309632364, 0.7982748169518101, 55.52910629020776, 0], 
                         'energy': [0, 0.04068999012754594, 0.04424410617830547, 0.05411287836661204, 0.057666994417371574, 0.06753576660567814, 0.07108988265643768, 0.14624821247604058, 0.14980232852680012, 0.2346967168769573, 0.23825083292771684, 0.2481196051160234, 0.25167372116678294, 0.27141126554339606, 0.27496538159415557, 0.28483415378246213, 0.28838826983322163, 0.3023448213058952, 0.3058989373566547, 0.3500334282916804, 0.3535875443424399, 0.36754409581511344, 0.37109821186587294, 0.3809669840541795, 0.384521100104939, 0.39847765157761256, 0.40203176762837206, 0.43761413177918435, 0.44116824782994385, 0.4510370200182504, 0.4545911360690099, 0.4857989338933828, 0.4893530499441423, 0.5033096014168159, 0.5068637174675754, 0.520820268940249, 0.5243743849910085, 0.5867899806397543, 0.5903440966905138, 0.6002128688788204, 0.6037669849295799, 0.6136357571178865, 0.617189873168646, 0.6270586453569527, 0.6306127614077122, 0.6404815335960188, 0.6440356496467783, 0.6539044218350849, 0.6574585378858444, 0.7015930288208702, 0.7051471448716297, 0.7150159170599363, 0.7185700331106958, 0.8310913483607857, 0.8346454644115452, 0.8445142365998518, 0.8480683526506113, 0.9251459274359293, 0.9287000434866888, 0.9426565949593624, 0.9462107110101219, 1.146038117656268, 1.146038117656268, 1.3789495045164086, 1.3825036205671681, 1.431847481508701, 1.4354015975594605, 1.470983961710273, 1.4745380777610324, 1.4966053232285452, 1.5001594392793047, 1.5100282114676113, 1.5135823275183709, 1.5275388789910445, 1.531092995041804, 1.5409617672301106, 1.54451588328087, 1.566583128748383, 1.5701372447991424, 1.6108272349266883, 1.6143813509774478, 1.6283379024501214, 1.631892018500881, 1.897433520156268, 1.897433520156268]}, 
            'box_bot8': {'locations': [(-2, 7, 1)], 
                         'times': [0], 
                         'energy': [0]}}

        self.robot_colors = {
            'box_bot0': ColorRGBA(r=1.0, g=0.0, b=0.0, a=1.0),  # Red
            'box_bot1': ColorRGBA(r=0.0, g=1.0, b=0.0, a=1.0),  # Green
            'box_bot2': ColorRGBA(r=0.0, g=0.0, b=1.0, a=1.0),  # Blue
            'box_bot3': ColorRGBA(r=0.0, g=0.0, b=0.0, a=1.0),  # Black
            'box_bot4': ColorRGBA(r=1.0, g=0.0, b=1.0, a=1.0),  # Magenta
            'box_bot5': ColorRGBA(r=0.0, g=1.0, b=1.0, a=1.0),  # Cyan
            'box_bot6': ColorRGBA(r=0.5, g=0.5, b=0.5, a=1.0),  # Grey
            'box_bot7': ColorRGBA(r=0.5, g=0.0, b=0.5, a=1.0),  # Purple
            'box_bot8': ColorRGBA(r=0.0, g=0.5, b=0.5, a=1.0)   # Teal
        }
        self.mesh_files = {'box_bot0':"package://box_bot_description/meshes/robot0.dae",
                           'box_bot1':"package://box_bot_description/meshes/robot1.dae",
                           'box_bot2':"package://box_bot_description/meshes/robot2.dae",
                           'box_bot3':"package://box_bot_description/meshes/robot3.dae",
                           'box_bot4':"package://box_bot_description/meshes/robot4.dae",
                           'box_bot5':"package://box_bot_description/meshes/robot5.dae",
                           'box_bot6':"package://box_bot_description/meshes/robot6.dae",
                           'box_bot7':"package://box_bot_description/meshes/robot7.dae",
                           'box_bot8':"package://box_bot_description/meshes/robot8.dae"}
        
        self.initial_color = ColorRGBA(r=1.0, g=1.0, b=0.0, a=1.0)  # Yellow for unvisited waypoints


        self.visited_waypoints = set()

        self.subscribers_ = []
        self.publishers_ = {}
        self.marker_pub = self.create_publisher(MarkerArray, 'visualization_marker_array', 10)
        current_seconds, current_nanoseconds = self.get_clock().now().seconds_nanoseconds()
        self.mission_start_time = current_seconds + current_nanoseconds / 1e9 
        self.current_idx = {f'box_bot{i}': 0 for i in range(9)}
        for i in range(9):
            robot_name = f'box_bot{i}'
            self.current_robot = robot_name
            self.publishers_[robot_name] = self.create_publisher(Twist, f'/{robot_name}/cmd_vel', 10)
            self.subscribers_.append(
                self.create_subscription(TFMessage, f'/{robot_name}/tf', lambda msg, name=robot_name: self.tf_callback(name, msg), 10))
            self.get_logger().info(f'Set up subscriber and publisher for {robot_name}')
        
        self.publish_initial_markers()
    
    def publish_initial_markers(self):
        marker_array = MarkerArray()
        for robot, waypoint_data in self.waypoints.items():
            for i, (x, y, z) in enumerate(waypoint_data['locations']):
                marker = Marker()
                marker.header.frame_id = "map"
                marker.ns = robot
                marker.id = i
                marker.type = Marker.CUBE
                marker.action = Marker.ADD
                marker.pose.position.x = float(x)-9.5
                marker.pose.position.y = float(y)-9.5
                marker.pose.position.z = float(z)
                marker.scale.x = 0.5
                marker.scale.y = 0.5
                marker.scale.z = 0.5
                marker.color = self.initial_color
                marker.lifetime = rclpy.duration.Duration(seconds=0).to_msg()
                marker_array.markers.append(marker)
        self.marker_pub.publish(marker_array)

    def tf_callback(self, robot_name, msg):
        wrapped_message = RobotTFWrapper(robot_name=robot_name, tf_message=msg)
        self.process_wrapped_message(wrapped_message)

    def process_wrapped_message(self, wrapped_message):
        self.get_logger().info(f'TF data received for {wrapped_message.robot_name}')
        for transform in wrapped_message.tf_message.transforms:
            if wrapped_message.robot_name.startswith('box_bot'):
                self.control_robot(wrapped_message,transform, wrapped_message.robot_name)

    def control_robot(self, wrapped_message, transform, robot_name):
        waypoint = self.waypoints.get(robot_name)
        if not waypoint:
            return

        locations = waypoint['locations']
        vel_lin = self.velocities[robot_name]
        times = waypoint['times']

        current_x = float(transform.transform.translation.x)
        current_y = float(transform.transform.translation.y)
        current_z = float(transform.transform.translation.z)
        current_theta = math.atan2(2.0 * (transform.transform.rotation.w * transform.transform.rotation.z),
                                   1.0 - 2.0 * (transform.transform.rotation.z**2))

        current_seconds, current_nanoseconds = self.get_clock().now().seconds_nanoseconds()
        current_time = (current_seconds + current_nanoseconds / 1e9 - self.mission_start_time)

        target_index = self.current_idx[robot_name]
        target_location = locations[target_index]
        target_x, target_y, _ = target_location
        self.get_logger().info(f'Send to {robot_name}: target: {target_index}')
        if self.reach_target(robot_name,locations,[current_x,current_y],target_index):
            self.current_idx[robot_name]+=1
            self.update_marker_color(robot_name, target_index)

        if target_index != 0:
            travel_time = times[target_index] #- current_time
        else: 
            travel_time = 0.0
        
        dx = target_x - current_x-9.5
        dy = target_y - current_y-9.5
        distance = math.sqrt(dx**2 + dy**2)
        self.get_logger().info(f'Send to {robot_name}: differences: {dx},{dy}, distance: {distance}')

        linear_velocity = distance / travel_time if travel_time > 0.0 else 0.0
        
        target_theta = math.atan2(dy, dx)
        angle_difference = target_theta - current_theta
        angle_difference = math.atan2(math.sin(angle_difference), math.cos(angle_difference))
        self.get_logger().info(f'Time: {travel_time}, Angle: {angle_difference}, current_time: {current_time}')
        
        if abs(angle_difference)<0.1:
            angular_velocity = 0.0
            linear_velocity = self.velocities[robot_name]/4 if travel_time > 0.0 else 0.0
        else:
            linear_velocity = 0.0
            angular_velocity = angle_difference/2.0  if travel_time > 0.0 else 0.0
        
        if self.detect_collision(wrapped_message, robot_name, current_x, current_y):
            self.get_logger().warn(f'Collision risk detected for {robot_name}, stopping movement.')
            angular_velocity = 0.0
            linear_velocity = 0.0
        elif abs(angle_difference) < 0.1:
            angular_velocity = 0.0
        else:
            angular_velocity = angle_difference/2.0 if travel_time > 0.0 else 0.0
            linear_velocity = 0.0

        self.get_logger().info(f'Send to {robot_name}: rotation: {angular_velocity}, linear: {linear_velocity}')
        
        twist = Twist()
        twist.linear.x = linear_velocity
        twist.angular.z = angular_velocity
        self.publishers_[robot_name].publish(twist)
        current_seconds, current_nanoseconds = self.get_clock().now().seconds_nanoseconds()
        self.mission_start_time = current_seconds + current_nanoseconds / 1e9 
    
    def reach_target(self, robot_name, X, Y, tgt_idx):
        if tgt_idx < (len(X)-1) and abs(X[tgt_idx][0]-Y[0]-9.5) <0.1 and abs(X[tgt_idx][1]-Y[1]-9.5) <0.1 :
            return True
        return False

    def detect_collision(self, wrapped_message, robot_name, current_x, current_y):
        for other_robot in self.waypoints.keys():
            if other_robot != robot_name:
                other_x, other_y, _ = self.get_current_position(wrapped_message,other_robot)
                if abs(current_x - other_x) < 0.2 and abs(current_y - other_y) < 0.2:
                    return True
        return False
    
    def update_marker_color(self, robot_name, index):
        marker_array = MarkerArray()
        marker = Marker()
        marker.header.frame_id = "map"
        marker.ns = robot_name
        marker.id = index
        marker.type = Marker.CUBE
        marker.action = Marker.MODIFY
        loc = self.waypoints[robot_name]['locations'][index]
        marker.pose.position.x = float(loc[0])-9.5
        marker.pose.position.y = float(loc[1])-9.5
        marker.pose.position.z = float(loc[1])+0.5
        marker.scale.x = 1.0
        marker.scale.y = 1.0
        marker.scale.z = 1.0
        marker.color = self.robot_colors[robot_name]
        marker.lifetime = rclpy.duration.Duration(seconds=0).to_msg()
        marker_array.markers.append(marker)

        image_marker = Marker()
        image_marker.header.frame_id = "map"
        image_marker.ns = robot_name
        image_marker.id = index + 100  # Different ID to avoid conflicts
        image_marker.type = Marker.MESH_RESOURCE
        image_marker.action = Marker.ADD
        image_marker.pose.position.x = float(loc[0]) - 9.5
        image_marker.pose.position.y = float(loc[1]) - 9.5
        image_marker.pose.position.z = float(loc[2]) + 1.0  # Adjust height
        image_marker.pose.orientation.w = 1.0
        image_marker.scale.x = 1.0
        image_marker.scale.y = 1.0
        image_marker.scale.z = 1.0
        image_marker.color = ColorRGBA(r=1.0, g=1.0, b=1.0, a=1.0)
        image_marker.mesh_resource = self.mesh_files[robot_name]
        image_marker.mesh_use_embedded_materials = True
        marker_array.markers.append(image_marker)
        self.marker_pub.publish(marker_array)

    def get_current_position(self, wrapped_message, robot_name):
        for transform in wrapped_message.tf_message.transforms:
            if wrapped_message.robot_name.startswith(robot_name):
                current_x_ = float(transform.transform.translation.x)
                current_y_ = float(transform.transform.translation.y)
                current_z_ = float(transform.transform.translation.z)
                return (current_x_, current_y_, current_z_)
        return (0.0,0.0,0.0)

def main(args=None):
    rclpy.init(args=args)
    robot_controller = RobotController()
    rclpy.spin(robot_controller)
    robot_controller.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()

        
